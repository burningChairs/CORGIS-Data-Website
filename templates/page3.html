{% extends "layout.html" %}
{% block content %}
<h2>Lifetime Statistics</h2>
<p>These charts shows the top astronauts ranked by number of missions and their lifetime mission durations (in days.)</p>
<p>(To view the Mission data by itself on the bar graph, tap on the Lifetime Durations color code! Vice versa for viewing the Lifetime Duration data.)</p>
<div>
    <label>Show top: 
        <select id="topN">
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="20">20</option>
        </select>
    </label>
</div>

<canvas id="statsChart" width="600" height="400"></canvas>
<canvas id="lineChart" width="600" height="200" style="margin-top:20px;"></canvas>

<!--Chart library-->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
	const raw = {{ stats | tojson }};
	const ctxBar = document.getElementById('statsChart').getContext('2d');
	const ctxLine = document.getElementById('lineChart').getContext('2d');
	let statsChart = null;
	let lineChart = null;
	
	function renderChart(n=10) {
    	// sort by missions desc and slice top n
    	const sorted = raw.slice().sort((a,b) => b.missions - a.missions).slice(0,n);
    	const labels = sorted.map(s => s.astronaut);
    	const missions = sorted.map(s => s.missions);
    	const durations = sorted.map(s => s.duration);
    	    
    	if (statsChart) statsChart.destroy();
    	statsChart = new Chart(ctxBar, {
    	    type: 'bar',
    	    data: {
    	        labels,
    	        datasets: [
    	            {
    	                label: 'Missions',
    	                data: missions,
    	                backgroundColor: '#000000'
    	            },
    	            {
    	                label: 'Lifetime duration (days)',
    	                data: durations,
    	                backgroundColor: '#6b2f51'
    	            }
    	        ]
    	    },
    	    options: {
    	        responsive: true,
    	        plugins: {
    	            tooltip: {
    	                callbacks: {
    	                    label: function(context) {
    	                        if(context.dataset.label === "Missions") return `Missions: ${context.raw}`;
    	                        if(context.dataset.label === "Lifetime duration (days)") return 'Duration: ${context.raw} days';
    	                    }
    	                }
    	            }
    	    
    	        },
    	        scales: {
    	            y: { beginAtZero: true }
    	        }
    	    }
        });

    if (lineChart) lineChart.destroy();
    lineChart = new Chart(ctxLine, {
    	    type: 'line',
    	    data: {
    	        labels,
    	        datasets: [{
    	            label: 'Lifetime Duration (days)',
    	            data: durations,
    	            fill: true,
    	            borderColor: '#6b2f51',
    	            backgroundColor: 'rgba(107,47,81,0.2)',
    	            tension: 0.3
    	    }]
    	},
    	options: {
    	    responsive: true,
    	    plugins: {
    	        legend: { display: false },
    	        tooltip: {
    	            callbackas: {
    	                label: function(context) {
    	                    return 'Duration: ${context.raw} days';
    	                }
    	            }
    	        }
    	        
    	    },
    	    scales: {
    	        y: { beginAtZero: true }
    	    }
    	}
    });
}
    	
	document.getElementById('topN').addEventListener('change', (e) => {renderChart(parseInt(e.target.value));
    });
    
    // original chart render
    renderChart(10);
</script>
{% endblock %}
